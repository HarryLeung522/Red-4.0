<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Red 4.0 - ä¸Šå‚³ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 15px; font-family: -apple-system, sans-serif; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-upload { font-size: 1rem; padding: 15px 5px; font-weight: bold; border-radius: 10px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-upload:active { transform: scale(0.95); opacity: 0.8; }
        .btn-upload span { font-size: 1.5rem; margin-bottom: 5px; }
        #preview { width: 100%; max-height: 250px; object-fit: contain; display: none; margin: 15px 0; border-radius: 10px; border: 1px solid #ddd; }
        #fileStatus { display: none; background: #e9ecef; padding: 12px; border-radius: 10px; text-align: center; margin: 15px 0; font-size: 0.9rem; color: #495057; border: 1px dashed #adb5bd; }
        .num-badge { background: #fff3cd; color: #856404; padding: 10px; text-align: center; border-radius: 8px; font-weight: bold; margin-bottom: 15px; border: 1px solid #ffeeba; }
        .header-title { color: #dc3545; font-weight: 800; text-align: center; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container mt-2">
    <h1 class="header-title">Red 4.0</h1>
    <div class="card p-4">
        <form id="mainForm">
            
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="btn btn-outline-primary btn-upload w-100">
                        <span>ğŸ“¸</span>æ‹ç…§/ä¸Šå‚³ç›¸ç‰‡
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                    </label>
                </div>
                <div class="col-6">
                    <label class="btn btn-outline-success btn-upload w-100">
                        <span>ğŸ“„</span>PDF æª”æ¡ˆ
                        <input type="file" id="pdfInput" accept="application/pdf" style="display: none;">
                    </label>
                </div>
            </div>

            <img id="preview">
            <div id="fileStatus"></div>

            <div class="mb-3">
                <label class="form-label fw-bold">Who pay</label>
                <select class="form-select form-select-lg" id="whoPay" required>
                    <option value="" disabled selected>è«‹é¸æ“‡...</option>
                    <option value="Harry Use">Harry Use</option>
                    <option value="Pi Direct payment">Pi Direct payment</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">é¡åˆ¥ / æ”¯ä»˜æ–¹å¼</label>
                <select class="form-select form-select-lg" id="category" disabled required></select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Type</label>
                <select class="form-select" id="type" required>
                    <option value="Rent">Rent</option>
                    <option value="Electricity">Electricity</option>
                    <option value="Logistic">Logistic</option>
                    <option value="Teaching Material">Teaching Material</option>
                    <option value="Admin">Admin</option>
                    <option value="Assets">Assets</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="row">
                <div class="col-6 mb-3">
                    <label class="form-label fw-bold">Date</label>
                    <input type="date" class="form-control" id="date" required>
                </div>
                <div class="col-6 mb-3">
                    <label class="form-label fw-bold">Amount</label>
                    <input type="number" step="0.01" class="form-control" id="amount" placeholder="0.00" required>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Item Name</label>
                <input type="text" class="form-control" id="itemName" placeholder="è«‹è¼¸å…¥é …ç›®åç¨±" required>
            </div>

            <div class="num-badge">ç³»çµ±ç·¨è™Ÿé è¦½ï¼š<span id="nextId">--</span></div>

            <button type="submit" id="submitBtn" class="btn btn-danger w-100 py-3 fw-bold">ç¢ºèªä¸¦å‚³é€è³‡æ–™</button>
        </form>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx8hdxwUDSs6z75MawUTU1qb70PyrY6WvLkGGIPAfAdPjggSdchWvYjugBsDR7VOiCMCg/exec";
    let selectedFile = null;

    document.getElementById('date').valueAsDate = new Date();

    // çµ±ä¸€è™•ç†æª”æ¡ˆé¸æ“‡èˆ‡é è¦½
    function handleFile(file, isImage) {
        selectedFile = file;
        const preview = document.getElementById('preview');
        const status = document.getElementById('fileStatus');
        
        if (isImage) {
            status.style.display = 'none';
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
            document.getElementById('pdfInput').value = ""; // æ¸…ç©ºå¦ä¸€å€‹
        } else {
            preview.style.display = 'none';
            status.innerText = "ğŸ“„ å·²é¸å– PDF: " + file.name;
            status.style.display = 'block';
            document.getElementById('imageInput').value = ""; // æ¸…ç©ºå¦ä¸€å€‹
        }
    }

    document.getElementById('imageInput').onchange = e => { if(e.target.files[0]) handleFile(e.target.files[0], true); };
    document.getElementById('pdfInput').onchange = e => { if(e.target.files[0]) handleFile(e.target.files[0], false); };

    // é€£å‹•é¸å–®èˆ‡è®€å–ç·¨è™Ÿ
    document.getElementById('whoPay').onchange = async function() {
        const cat = document.getElementById('category');
        cat.disabled = false;
        cat.innerHTML = "";
        const opts = this.value === "Harry Use" 
            ? ["Harry Claim", "Harry Personal"] 
            : ["HS", "HSBC", "HS cheque", "HSBC cheque", "HSBC Credit Card"];
        opts.forEach(o => cat.add(new Option(o, o)));

        const sheetName = this.value === "Harry Use" ? "å·¥ä½œè¡¨1" : "å·¥ä½œè¡¨2";
        document.getElementById('nextId').innerText = "è®€å–ä¸­...";
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getCount&sheetName=${encodeURIComponent(sheetName)}`);
            const data = await res.json();
            document.getElementById('nextId').innerText = data.nextId;
        } catch (e) { document.getElementById('nextId').innerText = "Error"; }
    };

    // æäº¤
    document.getElementById('mainForm').onsubmit = async (e) => {
        e.preventDefault();
        if (!selectedFile) return alert("è«‹å…ˆé¸æ“‡ç›¸ç‰‡æˆ– PDFï¼");

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "è™•ç†ä¸­...";

        const reader = new FileReader();
        reader.readAsDataURL(selectedFile);
        reader.onload = async () => {
            const payload = {
                whoPay: document.getElementById('whoPay').value,
                category: document.getElementById('category').value,
                type: document.getElementById('type').value,
                date: document.getElementById('date').value,
                itemName: document.getElementById('itemName').value,
                amount: document.getElementById('amount').value,
                sheetName: (document.getElementById('whoPay').value === "Harry Use") ? "å·¥ä½œè¡¨1" : "å·¥ä½œè¡¨2",
                image: reader.result.split(',')[1],
                mimeType: selectedFile.type
            };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("âœ… ä¸Šå‚³æˆåŠŸï¼");
                location.reload();
            } catch (err) {
                alert("âŒ å¤±æ•—: " + err);
                btn.disabled = false;
                btn.innerText = "ç¢ºèªä¸¦å‚³é€è³‡æ–™";
            }
        };
    };
</script>
</body>
</html>
