<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Red 4.0 - æ‹ç…§/PDFä¸Šå‚³</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 15px; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-upload { padding: 15px; font-weight: bold; margin-bottom: 10px; border-radius: 10px; }
        #preview { width: 100%; max-height: 200px; object-fit: contain; display: none; margin-bottom: 15px; border-radius: 10px; border: 1px solid #ddd; }
        #pdfNote { display: none; background: #e9ecef; padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 15px; color: #495057; }
        .num-badge { background: #fff3cd; color: #856404; padding: 8px; text-align: center; border-radius: 8px; font-weight: bold; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center my-3 fw-bold" style="color: #dc3545;">Red 4.0</h2>
    <div class="card p-4">
        <form id="mainForm">
            
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <label class="btn btn-outline-primary btn-upload w-100">
                        ğŸ“¸ å³æ™‚æ‹ç…§
                        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;">
                    </label>
                </div>
                <div class="col-6">
                    <label class="btn btn-outline-success btn-upload w-100">
                        ğŸ“„ ä¸Šå‚³ PDF
                        <input type="file" id="pdfInput" accept="application/pdf" style="display: none;">
                    </label>
                </div>
            </div>

            <img id="preview">
            <div id="pdfNote">å·²é¸å– PDF æª”æ¡ˆ</div>

            <div class="mb-3">
                <label class="form-label fw-bold">Who pay</label>
                <select class="form-select" id="whoPay" required>
                    <option value="" disabled selected>è«‹é¸æ“‡...</option>
                    <option value="Harry Use">Harry Use</option>
                    <option value="Pi Direct payment">Pi Direct payment</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">é¡åˆ¥ / æ”¯ä»˜æ–¹å¼</label>
                <select class="form-select" id="category" disabled required></select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Type</label>
                <select class="form-select" id="type" required>
                    <option value="Rent">Rent</option>
                    <option value="Electricity">Electricity</option>
                    <option value="Logistic">Logistic</option>
                    <option value="Teaching Material">Teaching Material</option>
                    <option value="Admin">Admin</option>
                    <option value="Assets">Assets</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="row">
                <div class="col-6 mb-3"><label class="form-label fw-bold">Date</label><input type="date" class="form-control" id="date" required></div>
                <div class="col-6 mb-3"><label class="form-label fw-bold">Amount</label><input type="number" step="0.01" class="form-control" id="amount" required></div>
            </div>

            <div class="mb-3"><label class="form-label fw-bold">Item Name</label><input type="text" class="form-control" id="itemName" required></div>

            <div class="num-badge">æ­£åœ¨å¡«å¯«ç·¨è™Ÿï¼š<span id="nextId">--</span></div>

            <button type="submit" id="submitBtn" class="btn btn-danger w-100 py-2 fw-bold">ç¢ºèªå‚³é€</button>
        </form>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx8hdxwUDSs6z75MawUTU1qb70PyrY6WvLkGGIPAfAdPjggSdchWvYjugBsDR7VOiCMCg/exec";
    let selectedFile = null;

    document.getElementById('date').valueAsDate = new Date();

    // è™•ç†æ‹ç…§
    document.getElementById('cameraInput').onchange = e => {
        selectedFile = e.target.files[0];
        if (selectedFile) {
            document.getElementById('pdfInput').value = ""; // æ¸…ç©ºå¦ä¸€å€‹ input
            document.getElementById('pdfNote').style.display = 'none';
            document.getElementById('preview').src = URL.createObjectURL(selectedFile);
            document.getElementById('preview').style.display = 'block';
        }
    };

    // è™•ç† PDF ä¸Šå‚³
    document.getElementById('pdfInput').onchange = e => {
        selectedFile = e.target.files[0];
        if (selectedFile) {
            document.getElementById('cameraInput').value = ""; // æ¸…ç©ºå¦ä¸€å€‹ input
            document.getElementById('preview').style.display = 'none';
            document.getElementById('pdfNote').style.display = 'block';
            document.getElementById('pdfNote').innerText = "ğŸ“„ å·²é¸å–: " + selectedFile.name;
        }
    };

    // é€£å‹•é¸å–®èˆ‡ç·¨è™Ÿ
    document.getElementById('whoPay').onchange = async function() {
        const cat = document.getElementById('category');
        cat.disabled = false;
        cat.innerHTML = "";
        const opts = this.value === "Harry Use" 
            ? ["Harry Claim", "Harry Personal"] 
            : ["HS", "HSBC", "HS cheque", "HSBC cheque", "HSBC Credit Card"];
        opts.forEach(o => cat.add(new Option(o, o)));

        const sheetName = this.value === "Harry Use" ? "å·¥ä½œè¡¨1" : "å·¥ä½œè¡¨2";
        document.getElementById('nextId').innerText = "è®€å–ä¸­...";
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getCount&sheetName=${encodeURIComponent(sheetName)}`);
            const data = await res.json();
            document.getElementById('nextId').innerText = data.nextId;
        } catch (e) { document.getElementById('nextId').innerText = "Error"; }
    };

    // æäº¤
    document.getElementById('mainForm').onsubmit = async (e) => {
        e.preventDefault();
        if (!selectedFile) return alert("è«‹å…ˆæ‹ç…§æˆ–é¸æ“‡ PDFï¼");

        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "ä¸Šå‚³ä¸­...";

        const reader = new FileReader();
        reader.readAsDataURL(selectedFile);
        reader.onload = async () => {
            const payload = {
                whoPay: document.getElementById('whoPay').value,
                category: document.getElementById('category').value,
                type: document.getElementById('type').value,
                date: document.getElementById('date').value,
                itemName: document.getElementById('itemName').value,
                amount: document.getElementById('amount').value,
                sheetName: document.getElementById('whoPay').value === "Harry Use" ? "å·¥ä½œè¡¨1" : "å·¥ä½œè¡¨2",
                image: reader.result.split(',')[1], // é€™æ˜¯ base64 å…§å®¹
                mimeType: selectedFile.type
            };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("âœ… ä¸Šå‚³æˆåŠŸï¼æª”æ¡ˆå·²å­˜å…¥ Driveã€‚");
                location.reload();
            } catch (err) {
                alert("âŒ å¤±æ•—: " + err);
                btn.disabled = false;
            }
        };
    };
</script>
</body>
</html>
