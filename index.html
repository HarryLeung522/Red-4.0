<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Red 4.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding: 15px; font-family: -apple-system, sans-serif; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header-title { color: #dc3545; font-weight: 800; text-align: center; margin-bottom: 20px; font-size: 2rem; }
        .preview-container { text-align: center; margin-bottom: 15px; }
        #preview { width: 100%; max-height: 250px; object-fit: contain; display: none; border-radius: 10px; border: 2px dashed #ccc; }
        .btn-submit { background-color: #dc3545; border: none; padding: 12px; font-weight: bold; font-size: 1.1rem; }
        .btn-submit:disabled { background-color: #a5a5a5; }
        .status-info { font-size: 0.9rem; color: #666; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>

<div class="container mt-2">
    <h1 class="header-title">Red 4.0</h1>
    
    <div class="card p-4">
        <form id="uploadForm">
            <div class="mb-4 text-center">
                <label for="cameraInput" class="btn btn-outline-secondary w-100 py-3">
                    ğŸ“· æ‹æ”æˆ–é¸å–ç›¸ç‰‡
                </label>
                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" required>
                <div class="preview-container mt-3">
                    <img id="preview" src="" alt="Preview">
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Who pay</label>
                <select class="form-select" id="whoPay" required>
                    <option value="" disabled selected>è«‹é¸æ“‡...</option>
                    <option value="Harry Use">Harry Use</option>
                    <option value="Pi Direct payment">Pi Direct payment</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">é¡åˆ¥ / æ”¯ä»˜æ–¹å¼</label>
                <select class="form-select" id="category" disabled required>
                    <option value="">è«‹å…ˆé¸æ“‡ Who pay</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Type</label>
                <select class="form-select" id="type" required>
                    <option value="Rent">Rent</option>
                    <option value="Electricity">Electricity</option>
                    <option value="Logistic">Logistic</option>
                    <option value="Teaching Material">Teaching Material</option>
                    <option value="Admin">Admin</option>
                    <option value="Assets">Assets</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Date</label>
                <input type="date" class="form-control" id="date" required>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Item Name</label>
                <input type="text" class="form-control" id="itemName" placeholder="è¼¸å…¥åç¨±" required>
            </div>

            <div class="mb-4">
                <label class="form-label fw-bold">Amount</label>
                <input type="number" step="0.01" class="form-control" id="amount" placeholder="0.00" required>
            </div>

            <div class="alert alert-light border text-center mb-4">
                æ­£åœ¨å¡«å¯«è³‡æ–™ç·¨è™Ÿ: <span id="recordNumber" class="fw-bold text-primary">ç­‰å¾…é¸æ“‡...</span>
            </div>

            <button type="submit" id="submitBtn" class="btn btn-danger w-100 btn-submit">å‚³é€è³‡æ–™åŠç›¸ç‰‡</button>
            
            <div id="loading" class="status-info" style="display:none;">
                <div class="spinner-border spinner-border-sm text-danger" role="status"></div>
                æ­£åœ¨è™•ç†ä¸Šå‚³ï¼Œè«‹ç¨å€™...
            </div>
        </form>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzd0J4pP4Oo86Tzr6qqGHzbbtvMMPJxaDV7_oFDIGmG2MUfQeaXbtmRaz88pNYI-oOitQ/exec";
    
    const cameraInput = document.getElementById('cameraInput');
    const preview = document.getElementById('preview');
    const whoPay = document.getElementById('whoPay');
    const category = document.getElementById('category');
    const recordNumber = document.getElementById('recordNumber');
    const uploadForm = document.getElementById('uploadForm');
    const submitBtn = document.getElementById('submitBtn');

    // é è¨­æ—¥æœŸç‚ºä»Šå¤©
    document.getElementById('date').valueAsDate = new Date();

    // åœ–ç‰‡é è¦½
    cameraInput.onchange = evt => {
        const [file] = cameraInput.files;
        if (file) {
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
        }
    }

    // é¸å–®é€£å‹•é‚è¼¯
    whoPay.addEventListener('change', function() {
        category.disabled = false;
        category.innerHTML = '';
        let options = [];
        let sheetName = "";

        if (this.value === "Harry Use") {
            options = ["Harry Claim", "Harry Personal"];
            sheetName = "å·¥ä½œè¡¨1";
        } else {
            options = ["HS", "HSBC", "HS cheque", "HSBC cheque", "HSBC Credit Card"];
            sheetName = "å·¥ä½œè¡¨2";
        }

        options.forEach(opt => {
            let el = document.createElement("option");
            el.textContent = opt;
            el.value = opt;
            category.appendChild(el);
        });

        // ç²å–æœ€æ–°ç·¨è™Ÿ
        recordNumber.innerText = "è®€å–ä¸­...";
        fetch(`${SCRIPT_URL}?action=getCount&sheetName=${encodeURIComponent(sheetName)}`)
            .then(res => res.json())
            .then(data => { recordNumber.innerText = data.nextId; })
            .catch(() => { recordNumber.innerText = "Error"; });
    });

    // æäº¤è¡¨å–®
    uploadForm.onsubmit = async (e) => {
        e.preventDefault();
        
        const file = cameraInput.files[0];
        if (!file) return alert("è«‹å…ˆé¸å–ç›¸ç‰‡");

        submitBtn.disabled = true;
        document.getElementById('loading').style.display = 'block';

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const base64 = reader.result.split(',')[1];
            
            const payload = {
                whoPay: whoPay.value,
                category: category.value,
                type: document.getElementById('type').value,
                date: document.getElementById('date').value,
                itemName: document.getElementById('itemName').value,
                amount: document.getElementById('amount').value,
                sheetName: whoPay.value === "Harry Use" ? "å·¥ä½œè¡¨1" : "å·¥ä½œè¡¨2",
                image: base64,
                mimeType: file.type
            };

            try {
                // ä½¿ç”¨ fetch ç™¼é€åˆ° GAS
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
                
                alert("å‚³é€æˆåŠŸï¼");
                location.reload(); // é‡ç½®è¡¨å–®
            } catch (err) {
                alert("å‚³é€å‡ºéŒ¯ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡æˆ– Script è¨­å®š");
                submitBtn.disabled = false;
                document.getElementById('loading').style.display = 'none';
            }
        };
    };
</script>

</body>
</html>