<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Red 4.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 15px; font-family: sans-serif; }
        .container { max-width: 500px; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { color: #d9534f; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .preview-img { width: 100%; max-height: 200px; object-fit: contain; display: none; margin-top: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .form-label { font-weight: bold; margin-top: 10px; }
        .id-badge { background: #e9ecef; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; color: #0d6efd; margin: 15px 0; }
        #loading { display: none; text-align: center; color: #d9534f; font-weight: bold; }
    </style>
</head>
<body>

<div class="container mt-3">
    <h2>Red 4.0</h2>

    <form id="expenseForm">
        <div class="mb-3">
            <label class="form-label">ğŸ“¸ æ‹æ”æˆ–é¸å–ç›¸ç‰‡</label>
            <input type="file" class="form-control" id="photo" accept="image/*" capture="environment" required>
            <img id="preview" class="preview-img">
        </div>

        <div class="mb-3">
            <label class="form-label">Who pay</label>
            <select class="form-select" id="whoPay" required>
                <option value="" disabled selected>è«‹é¸æ“‡...</option>
                <option value="Harry Use">Harry Use</option>
                <option value="Pi Direct payment">Pi Direct payment</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">é¡åˆ¥/æ”¯ä»˜æ–¹å¼</label>
            <select class="form-select" id="category" disabled required>
                <option value="">è«‹å…ˆé¸å– Who pay</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Type</label>
            <select class="form-select" id="type" required>
                <option value="Rent">Rent</option>
                <option value="Electricity">Electricity</option>
                <option value="Logistic">Logistic</option>
                <option value="Teaching Material">Teaching Material</option>
                <option value="Admin">Admin</option>
                <option value="Assets">Assets</option>
                <option value="Other">Other</option>
            </select>
        </div>

        <div class="row">
            <div class="col-6 mb-3">
                <label class="form-label">Date</label>
                <input type="date" class="form-control" id="date" required>
            </div>
            <div class="col-6 mb-3">
                <label class="form-label">Amount</label>
                <input type="number" class="form-control" id="amount" placeholder="0.00" required>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Item Name</label>
            <input type="text" class="form-control" id="itemName" placeholder="è¼¸å…¥é …ç›®" required>
        </div>

        <div class="id-badge">
            æ­£åœ¨å¡«å¯«ç¬¬ <span id="numDisplay">--</span> å‰‡è³‡æ–™
        </div>

        <button type="submit" class="btn btn-danger w-100 py-2" id="submitBtn">å‚³é€è³‡æ–™åŠç›¸ç‰‡</button>
        
        <div id="loading" class="mt-3">
            <div class="spinner-border spinner-border-sm"></div> æ­£åœ¨ä¸Šå‚³ï¼Œè«‹ç¨å€™...
        </div>
    </form>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzd0J4pP4Oo86Tzr6qqGHzbbtvMMPJxaDV7_oFDIGmG2MUfQeaXbtmRaz88pNYI-oOitQ/exec";
    
    const whoPay = document.getElementById('whoPay');
    const category = document.getElementById('category');
    const numDisplay = document.getElementById('numDisplay');
    const photo = document.getElementById('photo');
    const preview = document.getElementById('preview');

    // 1. é è¨­æ—¥æœŸ
    document.getElementById('date').valueAsDate = new Date();

    // 2. é è¦½åœ–ç‰‡
    photo.onchange = e => {
        const [file] = photo.files;
        if (file) {
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
        }
    };

    // 3. é¸å–®é€£å‹•èˆ‡ç²å–ç·¨è™Ÿ
    whoPay.onchange = async () => {
        category.disabled = false;
        category.innerHTML = "";
        let opts = whoPay.value === "Harry Use" 
            ? ["Harry Claim", "Harry Personal"] 
            : ["HS", "HSBC", "HS cheque", "HSBC cheque", "HSBC Credit Card"];
        
        opts.forEach(o => category.add(new Option(o, o)));

        // å‘ Google Script æ‹¿æœ€æ–°ç·¨è™Ÿ
        const sheetName = whoPay.value === "Harry Use" ? "å·¥ä½œè¡¨1" : "å·¥ä½œè¡¨2";
        numDisplay.innerText = "è®€å–ä¸­...";
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getCount&sheetName=${encodeURIComponent(sheetName)}`);
            const data = await res.json();
            numDisplay.innerText = data.nextId;
        } catch (e) {
            numDisplay.innerText = "Error";
        }
    };

    // 4. æäº¤è¡¨å–®
    document.getElementById('expenseForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const loader = document.getElementById('loading');
        
        btn.disabled = true;
        loader.style.display = "block";

        const file = photo.files[0];
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const payload = {
                whoPay: whoPay.value,
                category: category.value,
                type: document.getElementById('type').value,
                date: document.getElementById('date').value,
                itemName: document.getElementById('itemName').value,
                amount: document.getElementById('amount').value,
                sheetName: whoPay.value === "Harry Use" ? "å·¥ä½œè¡¨1" : "å·¥ä½œè¡¨2",
                image: reader.result.split(',')[1],
                mimeType: file.type
            };

            try {
                // ä½¿ç”¨ no-cors æ¨¡å¼ç™¼é€
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
                alert("ä¸Šå‚³æˆåŠŸï¼");
                location.reload();
            } catch (err) {
                alert("éŒ¯èª¤ï¼š" + err);
                btn.disabled = false;
                loader.style.display = "none";
            }
        };
    };
</script>
</body>
</html>
