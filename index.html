<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Red 4.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 15px; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-camera { background-color: #6c757d; color: white; margin-bottom: 10px; }
        #preview { width: 100%; max-height: 200px; object-fit: contain; display: none; margin-bottom: 15px; border-radius: 10px; }
        .num-badge { background: #fff3cd; color: #856404; padding: 8px; text-align: center; border-radius: 8px; font-weight: bold; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center my-3 fw-bold" style="color: #dc3545;">Red 4.0</h2>
    <div class="card p-4">
        <form id="mainForm">
            <label class="btn btn-camera w-100 py-3">
                ğŸ“· æ‹æ”æˆ–é¸æ“‡ç›¸ç‰‡
                <input type="file" id="fileInput" accept="image/*" capture="environment" style="display: none;" required>
            </label>
            <img id="preview">

            <div class="mb-3">
                <label class="form-label fw-bold">Who pay</label>
                <select class="form-select" id="whoPay" required>
                    <option value="" disabled selected>è«‹é¸æ“‡...</option>
                    <option value="Harry Use">Harry Use</option>
                    <option value="Pi Direct payment">Pi Direct payment</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">é¡åˆ¥ / æ”¯ä»˜æ–¹å¼</label>
                <select class="form-select" id="category" disabled required></select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Type</label>
                <select class="form-select" id="type" required>
                    <option value="Rent">Rent</option>
                    <option value="Electricity">Electricity</option>
                    <option value="Logistic">Logistic</option>
                    <option value="Teaching Material">Teaching Material</option>
                    <option value="Admin">Admin</option>
                    <option value="Assets">Assets</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="row">
                <div class="col-6 mb-3"><label class="form-label fw-bold">Date</label><input type="date" class="form-control" id="date" required></div>
                <div class="col-6 mb-3"><label class="form-label fw-bold">Amount</label><input type="number" step="0.01" class="form-control" id="amount" required></div>
            </div>

            <div class="mb-3"><label class="form-label fw-bold">Item Name</label><input type="text" class="form-control" id="itemName" required></div>

            <div class="num-badge">æ­£åœ¨å¡«å¯«ç·¨è™Ÿï¼š<span id="nextId">--</span></div>

            <button type="submit" id="submitBtn" class="btn btn-danger w-100 py-2 fw-bold">å‚³é€è³‡æ–™</button>
        </form>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzd0J4pP4Oo86Tzr6qqGHzbbtvMMPJxaDV7_oFDIGmG2MUfQeaXbtmRaz88pNYI-oOitQ/exec";
    
    document.getElementById('date').valueAsDate = new Date();

    document.getElementById('fileInput').onchange = e => {
        const [file] = e.target.files;
        if (file) {
            document.getElementById('preview').src = URL.createObjectURL(file);
            document.getElementById('preview').style.display = 'block';
        }
    };

    document.getElementById('whoPay').onchange = async function() {
        const cat = document.getElementById('category');
        cat.disabled = false;
        cat.innerHTML = "";
        const opts = this.value === "Harry Use" 
            ? ["Harry Claim", "Harry Personal"] 
            : ["HS", "HSBC", "HS cheque", "HSBC cheque", "HSBC Credit Card"];
        opts.forEach(o => cat.add(new Option(o, o)));

        const sheetName = this.value === "Harry Use" ? "å·¥ä½œè¡¨1" : "å·¥ä½œè¡¨2";
        document.getElementById('nextId').innerText = "è®€å–ä¸­...";
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getCount&sheetName=${encodeURIComponent(sheetName)}`);
            const data = await res.json();
            document.getElementById('nextId').innerText = data.nextId;
        } catch (e) { document.getElementById('nextId').innerText = "Error"; }
    };

    document.getElementById('mainForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "è™•ç†ä¸­...";

        const file = document.getElementById('fileInput').files[0];
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const payload = {
                whoPay: document.getElementById('whoPay').value,
                category: document.getElementById('category').value,
                type: document.getElementById('type').value,
                date: document.getElementById('date').value,
                itemName: document.getElementById('itemName').value,
                amount: document.getElementById('amount').value,
                sheetName: document.getElementById('whoPay').value === "Harry Use" ? "å·¥ä½œè¡¨1" : "å·¥ä½œè¡¨2",
                image: reader.result.split(',')[1],
                mimeType: file.type
            };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("âœ… æˆåŠŸï¼ç›¸ç‰‡å·²å‘½åä¸¦å¯«å…¥ H æ¬„ã€‚");
                location.reload();
            } catch (err) {
                alert("âŒ å¤±æ•—: " + err);
                btn.disabled = false;
            }
        };
    };
</script>
</body>
</html>
