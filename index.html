<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Red 4.0 ä¸Šå‚³ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; padding: 15px; font-family: -apple-system, sans-serif; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header-title { color: #dc3545; font-weight: 800; text-align: center; margin-bottom: 20px; }
        #preview { width: 100%; max-height: 250px; object-fit: contain; display: none; margin-top: 15px; border-radius: 10px; border: 1px solid #ddd; }
        .id-badge { background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin: 15px 0; border: 1px solid #ffeeba; }
        .btn-submit { background-color: #dc3545; border: none; font-weight: bold; padding: 12px; }
        .btn-submit:disabled { background-color: #6c757d; }
    </style>
</head>
<body>

<div class="container mt-2">
    <h1 class="header-title">Red 4.0</h1>
    <div class="card p-4">
        <form id="uploadForm">
            <div class="mb-4">
                <label class="btn btn-outline-secondary w-100 py-3 fw-bold">
                    ğŸ“· æ‹æ”å–®æ“š / é¸æ“‡ç›¸ç‰‡
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" required>
                </label>
                <img id="preview">
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Who pay</label>
                <select class="form-select form-select-lg" id="whoPay" required>
                    <option value="" disabled selected>è«‹é¸æ“‡ä»˜æ¬¾äºº...</option>
                    <option value="Harry Use">Harry Use</option>
                    <option value="Pi Direct payment">Pi Direct payment</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">é¡åˆ¥ / æ”¯ä»˜æ–¹å¼</label>
                <select class="form-select form-select-lg" id="category" disabled required>
                    <option value="">è«‹å…ˆé¸æ“‡ Who pay</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Type</label>
                <select class="form-select" id="type" required>
                    <option value="Rent">Rent</option>
                    <option value="Electricity">Electricity</option>
                    <option value="Logistic">Logistic</option>
                    <option value="Teaching Material">Teaching Material</option>
                    <option value="Admin">Admin</option>
                    <option value="Assets">Assets</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="row">
                <div class="col-6 mb-3">
                    <label class="form-label fw-bold">Date</label>
                    <input type="date" class="form-control" id="date" required>
                </div>
                <div class="col-6 mb-3">
                    <label class="form-label fw-bold">Amount</label>
                    <input type="number" step="0.01" class="form-control" id="amount" placeholder="0.00" required>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Item Name</label>
                <input type="text" class="form-control" id="itemName" placeholder="ä¾‹å¦‚ï¼šæ–‡å…·è³¼è²·" required>
            </div>

            <div class="id-badge">
                ç³»çµ±ç·¨è™Ÿé è¦½ï¼š<span id="recordNumber">--</span>
            </div>

            <button type="submit" id="submitBtn" class="btn btn-danger btn-submit w-100">ç¢ºèªä¸¦å‚³é€</button>
        </form>
    </div>
</div>

<script>
    // ä½¿ç”¨ä½ å‰›æä¾›çš„æ–°ç¶²å€
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx8hdxwUDSs6z75MawUTU1qb70PyrY6WvLkGGIPAfAdPjggSdchWvYjugBsDR7VOiCMCg/exec";
    
    // åˆå§‹åŒ–æ—¥æœŸ
    document.getElementById('date').valueAsDate = new Date();

    // ç›¸ç‰‡é è¦½
    document.getElementById('cameraInput').onchange = e => {
        const [file] = e.target.files;
        if (file) {
            document.getElementById('preview').src = URL.createObjectURL(file);
            document.getElementById('preview').style.display = 'block';
        }
    };

    // é¸å–®é€£å‹•èˆ‡ç²å–ç·¨è™Ÿ
    document.getElementById('whoPay').onchange = async function() {
        const cat = document.getElementById('category');
        const numSpan = document.getElementById('recordNumber');
        cat.disabled = false;
        cat.innerHTML = "";
        
        const options = this.value === "Harry Use" 
            ? ["Harry Claim", "Harry Personal"] 
            : ["HS", "HSBC", "HS cheque", "HSBC cheque", "HSBC Credit Card"];
        
        options.forEach(o => cat.add(new Option(o, o)));

        // è®€å–ç·¨è™Ÿ
        const sheetName = (this.value === "Harry Use") ? "å·¥ä½œè¡¨1" : "å·¥ä½œè¡¨2";
        numSpan.innerText = "è®€å–ä¸­...";
        try {
            const res = await fetch(`${SCRIPT_URL}?action=getCount&sheetName=${encodeURIComponent(sheetName)}`);
            const data = await res.json();
            numSpan.innerText = data.nextId;
        } catch (err) {
            numSpan.innerText = "Error";
        }
    };

    // è¡¨å–®æäº¤
    document.getElementById('uploadForm').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        const file = document.getElementById('cameraInput').files[0];
        
        if (!file) return alert("è«‹å…ˆæ‹æ”å–®æ“šï¼");

        btn.disabled = true;
        btn.innerText = "æ­£åœ¨ä¸Šå‚³ç›¸ç‰‡èˆ‡è³‡æ–™...";

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const payload = {
                whoPay: document.getElementById('whoPay').value,
                category: document.getElementById('category').value,
                type: document.getElementById('type').value,
                date: document.getElementById('date').value,
                itemName: document.getElementById('itemName').value,
                amount: document.getElementById('amount').value,
                sheetName: (document.getElementById('whoPay').value === "Harry Use") ? "å·¥ä½œè¡¨1" : "å·¥ä½œè¡¨2",
                image: reader.result.split(',')[1],
                mimeType: file.type
            };

            try {
                // ä½¿ç”¨ POST æäº¤
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });
                alert("âœ… ä¸Šå‚³æˆåŠŸï¼\nè³‡æ–™å·²å¯«å…¥è©¦ç®—è¡¨ï¼Œç›¸ç‰‡å·²å­˜å…¥ Google Driveã€‚");
                location.reload(); 
            } catch (err) {
                alert("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err);
                btn.disabled = false;
                btn.innerText = "ç¢ºèªä¸¦å‚³é€";
            }
        };
    };
</script>
</body>
</html>
